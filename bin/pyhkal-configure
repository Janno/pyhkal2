#!/usr/bin/env python

import sys
import couchdb
import yaml
from pyhkal.davenport import REMEMBER as UUID, DATABASE

def yaml2couch(path=None, couch=None):
    config = yaml.safe_load(open(path) if path else sys.stdin.read())
    db = couchdb.Server(couch or couchdb.client.DEFAULT_BASE_URI)[DATABASE]
    old = db.get(UUID, {})
    old.update(config)
    db[UUID] = old

if __name__ == '__main__':
    if len(sys.argv) not in (2, 3):
        print "usage: %s [pyhkal.yaml] [http://couchdb:5984/]" % sys.argv[0]
        sys.exit(1)
    yaml2couch(*sys.argv[1:3])
