#!/usr/bin/env python

import sys
import couchdb
import yaml
from pyhkal.davenport import REMEMBER as UUID, DATABASE

def yaml2couch(path="-", couch=couchdb.client.DEFAULT_BASE_URL, force=False):
    config = yaml.safe_load(open(path) if path != "-" else sys.stdin.read())
    db = couchdb.Server(couch)[DATABASE]
    old = db.get(UUID, {})
    if old:
        if force:
            config['_rev'] = old.rev
            old = config
        else:
            old.update(config)
        db.update([old])
    else:
        db[UUID] = config

if __name__ == '__main__':
    import optparse
    parser = optparse.OptionParser(
        usage="%prog [-h] [-f] [config] [server]",
        description="Relaxes PyHKAL on a comfy sofa.  "
        "By default, it reads from stdin and pushes to the local CouchDB.")
    parser.add_option("-f", "--force", action='store_true',
            help="ignore existing values")
    options, args = parser.parse_args()
    if len(args) > 2:
        parser.print_help()
        sys.exit(1)
    yaml2couch(force=options.force, *args)
